<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="/node_modules/three/build/three.js"></script>
    <script src="/node_modules/three/examples/js/loaders/GLTFLoader.js"></script>
    <script src="/node_modules/three/examples/js/controls/OrbitControls.js"></script>
    <script src="/node_modules/three/examples/js/loaders/RGBELoader.js"></script>
    <script src="/dist/rt-renderer.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      canvas {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <script>
      // import * as THREE from "./node_modules/three/build/three.js";
      // import { RGBELoader } from "./node_modules/three/examples/jsm/loaders/RGBELoader.js";
      // import { GLTFLoader } from "./node_modules/three/examples/jsm/loaders/GLTFLoader.js";
      // import { OrbitControls } from "./node_modules/three/examples/jsm/controls/OrbitControls.js";

      // import {
      //   RayTracingRenderer,
      //   RayTracingMaterial,
      //   DirectionalLight,
      //   PointLight,
      //   QuadLight,
      //   RectAreaLight,
      //   SphereAreaLight,
      // } from "./build/rt-renderer.js";

      async function ae() {
        let e = [];
        const i = [],
          t = new THREE.TextureLoader();
        return (
          [
            "/assets/diningRoom/textures/book1.jpg",
            "/assets/diningRoom/textures/book2.jpg",
            "/assets/diningRoom/textures/book3.jpg",
            "/assets/diningRoom/textures/book4.jpg",
            "/assets/diningRoom/textures/book6.jpg",
            "/assets/diningRoom/textures/book7.jpg",
            "/assets/diningRoom/textures/book8.jpg",
            "/assets/diningRoom/textures/book9.jpg",
            "/assets/diningRoom/textures/book10.jpg",
            "/assets/diningRoom/textures/book11.jpg",
            "/assets/diningRoom/textures/book14.jpg",
            "/assets/diningRoom/textures/book15.jpg",
            "/assets/diningRoom/textures/book16.jpg",
            "/assets/diningRoom/textures/book17.jpg",
            "/assets/diningRoom/textures/book18.jpg",
            "/assets/diningRoom/textures/box.jpg",
            "/assets/diningRoom/textures/floor.jpg",
            "/assets/diningRoom/textures/painting.jpg",
            "/assets/diningRoom/textures/shelfbook1.jpg",
            "/assets/diningRoom/textures/shelfbook2.jpg",
          ].forEach((r) => {
            i.push(
              new Promise((m) => {
                t.load(r, m);
              })
            );
          }),
          await Promise.all(i).then((r) => {
            e = r;
          }),
          e
        );
      }
      async function oe() {
        const e = await ae(),
          i = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.005, 0.005, 0.005),
            roughness: 0.4472,
          }),
          l = new THREE.RayTracingMaterial({
            color: new THREE.Color(1, 1, 1),
            roughness: 0.3872,
            metalness: 1,
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          r = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.713, 0.8, 0.8),
            transmission: 1,
            roughness: 0.01,
            emissiveMap: e[16],
            alpha: 0.1,
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          m = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.787, 0.758, 0.737),
            roughness: 0,
            clearcoat: 1,
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          P = new THREE.RayTracingMaterial({
            map: e[16],
            roughness: 0.2236,
            // transmission: 1,
            subsurface: 1,
          }),
          x = new THREE.RayTracingMaterial({
            map: e[16],
            roughness: 0.3162,
            transmission: 1,
          }),
          R = new THREE.RayTracingMaterial({
            map: e[17],
            transmission: 1,
          }),
          h = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.842, 0.842, 0.842),
            roughness: 0.44721,
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          j = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.016, 0.047, 0.002),
            roughness: 0.44721,
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          g = new THREE.RayTracingMaterial({
            color: new THREE.Color(0.009, 0.009, 0.009),
            roughness: 0.44721,
            clearcoat: 1,
            subsurface: 1,
            atDistance: 0.4,
            transmission: 1,
            extinction: new THREE.Color(0.009, 0.009, 0.009),
          }),
          t = new THREE.RayTracingMaterial({
            roughness: 0,
            metalness: 1,
            subsurface: 1,
            atDistance: 0.4,
            transmission: 1,
            extinction: new THREE.Color(0.009, 0.009, 0.009),
          }),
          p = new THREE.RayTracingMaterial({
            map: e[18],
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          _ = new THREE.RayTracingMaterial({
            map: e[19],
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          z = new THREE.RayTracingMaterial({
            map: e[0],
            subsurface: 0.3,
            atDistance: 0.4,
          }),
          S = new THREE.RayTracingMaterial({
            map: e[1],
          }),
          w = new THREE.RayTracingMaterial({
            map: e[2],
          }),
          L = new THREE.RayTracingMaterial({
            map: e[3],
          }),
          E = new THREE.RayTracingMaterial({
            map: e[4],
          }),
          y = new THREE.RayTracingMaterial({
            map: e[5],
          }),
          D = new THREE.RayTracingMaterial({
            map: e[6],
          }),
          T = new THREE.RayTracingMaterial({
            map: e[7],
          }),
          v = new THREE.RayTracingMaterial({
            map: e[8],
          }),
          A = new THREE.RayTracingMaterial({
            map: e[9],
          }),
          G = new THREE.RayTracingMaterial({
            map: e[10],
          }),
          F = new THREE.RayTracingMaterial({
            map: e[11],
          }),
          I = new THREE.RayTracingMaterial({
            map: e[12],
          }),
          W = new THREE.RayTracingMaterial({
            map: e[13],
          }),
          O = new THREE.RayTracingMaterial({
            map: e[14],
          });
        //   Oe = new DisneyMaterial({
        //     emission: [20, 20, 20],
        //   });
        return [
          {
            material: null,
            meshName: [
              "Plane",
              "Plane224_Plane005",
              "Plane223_Plane004",
              "Plane220_Plane001",
              "Plane221_Plane002",
              "Plane222_Plane003",
            ],
          },
          {
            material: z,
            meshName: ["1_Cube011"],
          },
          {
            material: S,
            meshName: ["3_Cube025"],
          },
          {
            material: w,
            meshName: ["5_Cube027"],
          },
          {
            material: L,
            meshName: ["6_Cube028"],
          },
          {
            material: p,
            meshName: ["7_Cube029"],
          },
          {
            material: E,
            meshName: ["9_Cube031"],
          },
          {
            material: y,
            meshName: ["10_Cube014"],
          },
          {
            material: D,
            meshName: ["11_Cube015"],
          },
          {
            material: T,
            meshName: ["12_Cube016"],
          },
          {
            material: v,
            meshName: ["13_Cube017"],
          },
          {
            material: A,
            meshName: ["14_Cube018"],
          },
          {
            material: _,
            meshName: ["15_small_Cube019"],
          },
          {
            material: w,
            meshName: ["16_small_Cube020"],
          },
          {
            material: G,
            meshName: ["17_small_Cube021"],
          },
          {
            material: F,
            meshName: ["18_Cube022"],
          },
          {
            material: I,
            meshName: ["19_Cube023"],
          },
          {
            material: W,
            meshName: ["Plane002_Plane000"],
          },
          {
            material: O,
            meshName: ["Plane012"],
          },
          {
            material: x,
            meshName: [
              "Vildapel_Bamboo_Planter001_Cube034",
              "Vildapel_Bamboo_Planter_Cube033",
              "Vildapel_Bamboo_Planter003_Cube036",
              "Vildapel_Bamboo_Planter002_Cube035",
            ],
          },
          {
            material: t,
            meshName: [
              "BezierCircle000",
              "BezierCircle001",
              "BezierCircle002",
              "BezierCircle003",
              "BezierCircle004",
              "BezierCircle005",
              "BezierCircle006",
              "BezierCircle007",
              "BezierCircle008",
              "BezierCircle009",
              "BezierCircle010",
              "BezierCircle011",
              "BezierCircle012",
              "BezierCircle013",
              "BezierCircle014",
              "BezierCircle015",
            ],
          },
          {
            material: t,
            meshName: [
              "Bolt002_Bolt001",
              "Bolt001_Bolt000",
              "Bolt003_Bolt002",
              "Bolt002_Bolt005",
            ],
          },
          {
            material: i,
            meshName: [
              "Circle002_Circle007",
              "Circle003_Circle002",
              "Circle005_Circle008",
              "Circle007_Circle010",
            ],
          },
          {
            material: i,
            meshName: [
              "Circle000_Circle005",
              "Circle001",
              "Circle004_Circle006",
              "Circle006_Circle009",
            ],
          },
          {
            material: g,
            meshName: ["Cube002_Cube", "Cube011_Cube003"],
          },
          {
            material: P,
            meshName: [
              "Cube012_Cube010",
              "Cube005_Cube000",
              "Cube006_Cube001",
              "Cube007_Cube012",
            ],
          },
          {
            material: t,
            meshName: ["Cube014_Cube024", "Cube015_Cube026"],
          },
          {
            material: h,
            meshName: ["Cube000_Cube002"],
          },
          {
            material: j,
            meshName: ["Cube013_Cube004"],
          },
          {
            material: R,
            meshName: ["Cube003_Cube009", "Cube004_Cube008"],
          },
          {
            material: g,
            meshName: [
              "decoration_twig_branch003_Plane007",
              "decoration_twig_branch004_Plane010",
              "decoration_twig_branch007_Plane011",
            ],
          },
          {
            material: h,
            meshName: ["Cube001_Cube005"],
          },
          {
            material: r,
            meshName: ["Cube010_Cube013"],
          },
          {
            material: l,
            meshName: ["Cube008_Cube006", "Cube009_Cube007"],
          },
          {
            material: m,
            meshName: ["Circle"],
          },
          {
            material: p,
            meshName: ["17_small002_Cube038"],
          },
          {
            material: _,
            meshName: ["17_small001_Cube037"],
          },
          {
            material: l,
            meshName: [
              "Circle008_Circle004",
              "Circle009_Circle011",
              "Circle010_Circle012",
            ],
          },
          {
            material: g,
            meshName: ["Cylinder009_Cylinder007"],
          },
        ];
      }

      const envMapPath = "./assets/gray-background-with-dirlight_1k.hdr";
      const envMapPath2 = "./assets/book1.jpg";
      const envMapPath3 = "./assets/piz_compressed.exr";

      const gltfModelPath = "./assets/diningRoom/scene.gltf";

      const renderer = new THREE.RayTracingRenderer({
        canvasAlpha: true,
      });

      renderer.useWorker = false;
      renderer.bounces = 2;
      renderer.envMapIntensity = 2;
      renderer.enviromentVisible = true;
      renderer.enableDenoise = true;
      renderer.enableTemporalDenoise = true;
      renderer.enableSpatialDenoise = true;
      renderer.movingDownsampling = true;
      renderer.renderWhenOffFocus = false;
      renderer.useTileRender = false;
      renderer.setDenoiseColorBlendFactor(0.6);
      renderer.setDenoiseColorFactor(0.6);
      renderer.setDenoiseMomentBlendFactor(0.6);
      renderer.setDenoisePositionFactor(0.4);
      renderer.setDenoiseNormalFactor(0.1);
      renderer.setDemodulateAlbedo(0.1);
      // renderer.toneMapping = THREE.LinearToneMapping;

      setTimeout(() => {
        renderer.toneMapping = THREE.ReinhardToneMapping;
        // renderer.needsUpdate = true;
      }, 6000);
      // renderer.toneMappingExposure = 20;

      document.body.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const sphereGeometry = new THREE.SphereGeometry(1, 168, 64);
      // Look here
      const rayTracingMaterial = new THREE.MeshPhongMaterial({
        subsurface: 0.6,
        color: new THREE.Color("orange"),
        // atDistance: 0.001,
        // ior: 1.9,
        emissive: new THREE.Color("red"),
        // transmission: 0.5,
        extinction: new THREE.Color("red"),
      });
      const sphereMesh = new THREE.Mesh(sphereGeometry, rayTracingMaterial);
      //sphereMesh.position.z = -10;
      const camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight
      );

      camera.position.set(
        -1.4141610975212875,
        -0.5500411049703974,
        -4.76420016089798
      );

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      //  controls.enableDamping = true;
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.y = 1;
      const directionalLight2 = new THREE.DirectionalLight(0xffff33, 1);
      directionalLight.position.y = 10;

      renderer.setSize(window.innerWidth, window.innerHeight);
      async function init() {
        // Note that if it is after R136, it needs to be declared as FloatType
        const rgbeLoader = new THREE.RGBELoader().setDataType(THREE.FloatType);
        const envMap = await new Promise((resolve) => {
          rgbeLoader.load(envMapPath, resolve);
        });

        const rgbeLoader2 = new THREE.TextureLoader();
        const envMap2 = await new Promise((resolve) => {
          rgbeLoader2.load(envMapPath2, resolve);
        });

        // const rgbeLoader3 = new EXRLoader().setDataType(THREE.FloatType);
        // const envMap3 = await new Promise((resolve) => {
        //   rgbeLoader3.load(envMapPath3, resolve);
        // });

        scene.environment = envMap;

        // scene.environment = new THREE.Color("white");

        const gltfLoader = new THREE.GLTFLoader();
        const gltfInfo = await new Promise((resolve) => {
          gltfLoader.load(gltfModelPath, resolve);
        });
        const i = await oe();
        gltfInfo.scene.traverse((t) => {
          t.isMesh &&
            i.forEach((l) => {
              const r = l.meshName,
                m = l.material;
              if (~r.indexOf(t.name)) {
                m ? (t.material = m) : (t.visible = !1);
                return;
              }
            });
        }),
          gltfInfo.scene.traverse((t) => {
            if (t.isMesh && t.material) {
              if (t.material.isRayTracingMaterial) return;
              t.material.isMeshStandardMaterial
                ? (t.material =
                    new THREE.RayTracingMaterial().fromStandardMaterial(
                      t.material
                    ))
                : (t.material = new THREE.RayTracingMaterial());
            }
          });

        scene.add(gltfInfo.scene);
        const radius = 2;
        const sphereAreaLight = new THREE.SphereAreaLight(
          0xffffff,
          100,
          radius
        );
        sphereAreaLight.position.set(0, 5, 0);
        scene.add(sphereAreaLight);
        sphereAreaLight.visible = false;
        const width = 10;
        const height = 10;
        const rectAreaLight = new THREE.RectAreaLight(
          0xffffff,
          100,
          width,
          height
        );
        rectAreaLight.position.set(10, 12, 0);
        rectAreaLight.target.set(0, 4, 0);
        scene.add(rectAreaLight);
        rectAreaLight.visible = false;
        const quad = new THREE.QuadLight();
        quad.color = new THREE.Color("white");
        quad.v1 = new THREE.Vector3(1, 1, 1);
        quad.v2 = new THREE.Vector3(7, 1, 1);
        quad.position.set(0, 10, 0);

        scene.add(quad);

        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(2, 5, 0);
        scene.add(pointLight);

        scene.add(directionalLight, directionalLight2);

        scene.add(sphereMesh);

        await renderer.buildScene(scene, camera).then(() => {
          tick();
        });
      }

      function tick() {
        renderer.render(scene, camera);
        controls.update();
        requestAnimationFrame(tick);
        //   console.log(renderer.getTotalSamples());
      }

      init();

      // renderer.fullSampleCallback = () => {
      //   offScreenCtx.drawImage(renderer.domElement, 0, 0);
      //   const fullSampleImgData = offScreenCanvas.toDataURL(`image/jpeg`);
      // };

      renderer.loadingCallback = {
        onProgress: (e) => console.log(e),
        onComplete: (e) => {
          console.log(e);
        },
      };
    </script>
  </body>
</html>
